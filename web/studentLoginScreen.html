<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ThesiScan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/studentLoginScreen.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
  </head>
  <body>
    <!-- Logo -->
    <img src="images/main logo.png" alt="ThesiScan Logo" class="logo" />

    <!-- Login Box -->
    <div class="login-box">
      <h2>Student Login</h2>
      <form id="loginForm">
        <input
          type="text"
          id="studentIdInput"
          placeholder="Username"
          required
        />
        <div class="input-group">
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />
          <button
            type="button"
            class="toggle-password"
            onclick="togglePassword()"
          >
            <i id="eyeIcon" class="fa-solid fa-eye"></i>
          </button>
        </div>

        <button type="submit" class="login-button">
          <span class="btn-text"></span>Login
        </button>
      </form>
      <div
        style="display: flex; justify-content: space-between; margin-top: 15px"
      >
        <a href="./" class="back-link">‚Üê Back to role selection</a>

        <a href="studForgotPass.html" class="forgot-password"
          >Forgot Password?</a
        >
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
      const notyf = new Notyf();

      function togglePassword() {
        const passwordField = document.getElementById("password");
        const eyeIcon = document.getElementById("eyeIcon");
        const isHidden = passwordField.type === "password";

        passwordField.type = isHidden ? "text" : "password";
        eyeIcon.classList.toggle("fa-eye");
        eyeIcon.classList.toggle("fa-eye-slash");
      }

      const button = document.querySelector(".login-button");
      const btnText = button.querySelector(".btn-text");

      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const studentId = document
            .getElementById("studentIdInput")
            .value.trim();
          const password = document.getElementById("password").value;

          // Add spinner
          const spinner = document.createElement("span");
          spinner.className = "spinner";
          button.appendChild(spinner);
          button.disabled = true;

          try {
            const response = await fetch(
              "https://thesis-scan-backend-production.up.railway.app/login/",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                  student_id: studentId,
                  password: password,
                }),
              }
            );
            if (response.ok) {
              // Store user info in localStorage for profile page
              const student = await response.json();
              localStorage.setItem("token", student.token);
              localStorage.setItem("studentId", student.id);

              window.location.href = "studentDashboard.html";
            } else {
              let message = "These credentials do not match our records.";
              try {
                const data = await response.json();
                if (data && data.detail) message = data.detail;
              } catch (e) {}
              notyf.error(message);
            }
          } catch (err) {
            notyf.error("Network error. Please try again later.");
          } finally {
            // Remove spinner and re-enable button
            spinner.remove();
            button.disabled = false;
          }
        });
    </script>
  </body>
</html>
