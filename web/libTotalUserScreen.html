<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Total Users</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="images/FINAL_sub-logo.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/libTotalUserScreen.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img src="images/FINAL_sub-logo.png" alt="Logo" />
        <span class="logo-text">ThesiScan</span>
      </div>
      <nav class="nav-links">
        <a href="librarianDashboard.html"
          ><i class="fas fa-home"></i><span class="link-text">Home</span></a
        >
        <a href="libViewProfScreen.html"
          ><i class="fas fa-user"></i><span class="link-text">Profile</span></a
        >
        <a href="libBookReportScreen.html"
          ><i class="fas fa-book"></i
          ><span class="link-text">Book Reports</span></a
        >
        <a href="libAccSettScreen.html"
          ><i class="fas fa-cog"></i><span class="link-text">Settings</span></a
        >
      </nav>
      <div class="logout-link">
        <a href="#" onclick="logout()"
          ><i class="fas fa-sign-out-alt"></i
          ><span class="link-text">Logout</span></a
        >
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="top-bar">
        <h3 class="page-title">Total Users</h3>
        <div class="search-bar">
          <input
            id="globalSearch"
            type="text"
            placeholder="Search users by ID, Name..."
          />
          <button id="globalSearchBtn" type="submit">Search</button>
        </div>
        <div style="gap: 10px; display: flex">
          <button id="addStudentBtn" class="add-btn">+ Add Student</button>
          <button id="addLibrarianBtn" class="add-btn">+ Add Librarian</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <h3>0</h3>
          <p>Total Users</p>
        </div>
        <div class="stat-box">
          <h3>0</h3>
          <p>Active This Week</p>
        </div>
        <div class="stat-box">
          <h3>0</h3>
          <p>New Users</p>
        </div>
      </div>

      <div class="table-section">
        <h3>Librarians</h3>
        <div class="table-wrapper">
          <div class="loading" id="librarianLoading">
            <span class="spinner"></span> Loading librarians...
          </div>
          <table id="librarianTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="table-section" style="margin-top: 30px">
        <h3>Students</h3>
        <div class="table-wrapper">
          <div class="loading" id="studentLoading">
            <span class="spinner"></span> Loading students...
          </div>
          <table id="studentTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Student ID</th>
                <th>Program</th>
                <th>Year Level</th>
                <th>Last Login</th>
                <th class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New User</h2>
          <span class="close">&times;</span>
        </div>
        <form id="addUserForm">
          <div class="form-group">
            <label for="full_name">Full Name</label>
            <input type="text" id="full_name" name="full_name" required />
          </div>
          <div class="form-group">
            <label for="student_id">Student ID</label>
            <input type="text" id="student_id" name="student_id" required />
          </div>
          <div class="form-group">
            <label for="program_course">Program/Course</label>
            <input
              type="text"
              id="program_course"
              name="program_course"
              required
            />
          </div>
          <div class="form-group">
            <label for="year_level">Year Level</label>
            <input type="text" id="year_level" name="year_level" required />
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="username"
            />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
            />
          </div>

          <!-- Librarian-specific fields -->
          <div id="librarianFields" style="display: none">
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="username" name="username" required />
            </div>
            <!-- Role is fixed, no select needed -->
          </div>

          <button type="submit" class="save-btn">Create User</button>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
      const notyf = new Notyf();

      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "./";
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("librarianId");
        window.location.href = "index.html"; // send back to role selection
      }

      function getTimeAgo(date) {
        const now = new Date();
        const loginDate = new Date(date);
        const diffMs = now - loginDate;

        const minutes = Math.floor(diffMs / 1000 / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const weeks = Math.floor(days / 7);

        if (minutes < 1) return "Just now";
        if (minutes < 60) return `${minutes} min${minutes > 1 ? "s" : ""} ago`;
        if (hours < 24) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
        if (days < 7) return `${days} day${days > 1 ? "s" : ""} ago`;
        return `${weeks} week${weeks > 1 ? "s" : ""} ago`;
      }

      document.addEventListener("DOMContentLoaded", async () => {
        // Fetch user statistics
        async function fetchStats() {
          try {
            const response = await fetch(
              "https://thesis-scan-backend-production.up.railway.app/reports/stats/"
            );
            const data = await response.json();

            // Update statistics boxes
            document.querySelector(".stats").innerHTML = `
                    <div class="stat-box">
                      <h3>${data.total_users}</h3>
                      <p>Total Users</p>
                    </div>
                    <div class="stat-box">
                      <h3>${data.active_users_this_week || 0}</h3>
                      <p>Active This Week</p>
                    </div>
                    <div class="stat-box">
                      <h3>${data.new_users_this_month || 0}</h3>
                      <p>New Users This Month</p>
                    </div>
                  `;
          } catch (error) {
            console.error("Error fetching stats:", error);
          }
        }

        // Fetch users data
        async function fetchUsers() {
          const librarianLoading = document.getElementById("librarianLoading");
          const studentLoading = document.getElementById("studentLoading");
          const librarianTable = document.getElementById("librarianTable");
          const studentTable = document.getElementById("studentTable");

          // Show loading
          librarianLoading.style.display = "flex";
          studentLoading.style.display = "flex";
          librarianTable.style.display = "none";
          studentTable.style.display = "none";

          try {
            const resStudents = await fetch(
              "https://thesis-scan-backend-production.up.railway.app/users/list/"
              // "http://127.0.0.1:8000/users/list/"
            );
            const students = await resStudents.json();

            const resLibrarians = await fetch(
              "https://thesis-scan-backend-production.up.railway.app/librarians/list/"
            );
            const librarians = await resLibrarians.json();

            updateStudentTable(students);
            updateLibrarianTable(librarians);
          } catch (error) {
            console.error("Error fetching users:", error);
          } finally {
            // Hide loading and show tables
            librarianLoading.style.display = "none";
            studentLoading.style.display = "none";
            librarianTable.style.display = "table";
            studentTable.style.display = "table";
          }
        }

        // Update student table
        function updateStudentTable(students) {
          const tbody = document.querySelector("#studentTable tbody");
          tbody.innerHTML = "";

          students.forEach((student) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${student.full_name}</td>
            <td>${student.student_id}</td>
            <td>${student.program_course}</td>
            <td>${student.year_level}</td>
      <td class="last-login" data-login="${student.last_login}">
        ${student.last_login ? getTimeAgo(student.last_login) : "Never"}
      </td>
            <td>
              <button class="delete-btn" data-id="${
                student.id
              }" data-role="student">Delete</button>
            </td>
          `;
            tbody.appendChild(row);
          });

          attachDeleteHandlers("#studentTable tbody .delete-btn");
        }

        // Update librarian table
        function updateLibrarianTable(librarians) {
          const tbody = document.querySelector("#librarianTable tbody");
          tbody.innerHTML = "";

          librarians.forEach((librarian) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${librarian.full_name}</td>
            <td>${librarian.username}</td>
            <td>${librarian.email}</td>
            <td>${librarian.role}</td>
            <td>
              <button class="delete-btn" data-id="${librarian.id}" data-role="librarian">Delete</button>
            </td>
          `;
            tbody.appendChild(row);
          });

          attachDeleteHandlers("#librarianTable tbody .delete-btn");
        }

        // Attach delete handlers
        function attachDeleteHandlers(selector) {
          document.querySelectorAll(selector).forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const userId = btn.dataset.id;
              const role = btn.dataset.role;

              if (confirm("Are you sure you want to delete this user?")) {
                try {
                  const res = await fetch(
                    `https://thesis-scan-backend-production.up.railway.app/${
                      role === "librarian" ? "librarians" : "users"
                    }/${userId}`,
                    {
                      method: "DELETE",
                      headers: { Authorization: `Bearer ${token}` },
                    }
                  );
                  if (!res.ok) throw new Error("Failed to delete user");
                  notyf.success("User deleted successfully!");
                  await fetchUsers();
                } catch (err) {
                  console.error(err);
                  notyf.error("Error deleting user.");
                }
              }
            });
          });
        }

        function setupPagination() {
          const rowsPerPage = 4;
          const table = document.getElementById("userTable");
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const pagination = document.getElementById("pagination");
          let currentPage = 1;
          const totalPages = Math.ceil(rows.length / rowsPerPage);

          function displayPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            rows.forEach((row, i) => {
              row.style.display = i >= start && i < end ? "" : "none";
            });
            renderPagination(page);
          }

          function renderPagination(current) {
            pagination.innerHTML = "";

            const prevBtn = document.createElement("button");
            prevBtn.textContent = "Previous";
            prevBtn.disabled = current === 1;
            prevBtn.className = "page-btn";
            prevBtn.addEventListener("click", () => {
              if (currentPage > 1) {
                currentPage--;
                displayPage(currentPage);
              }
            });
            pagination.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
              const btn = document.createElement("button");
              btn.textContent = i;
              btn.className = "page-btn" + (i === current ? " active" : "");
              btn.addEventListener("click", () => {
                currentPage = i;
                displayPage(currentPage);
              });
              pagination.appendChild(btn);
            }

            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next";
            nextBtn.disabled = current === totalPages;
            nextBtn.className = "page-btn";
            nextBtn.addEventListener("click", () => {
              if (currentPage < totalPages) {
                currentPage++;
                displayPage(currentPage);
              }
            });
            pagination.appendChild(nextBtn);
          }

          displayPage(currentPage);
        }

        // Initialize search functionality
        const searchInput = document.getElementById("globalSearch");
        const searchBtn = document.getElementById("globalSearchBtn");

        function runSearch() {
          const term = searchInput.value.toLowerCase();

          const allRows = [
            ...document.querySelectorAll("#studentTable tbody tr"),
            ...document.querySelectorAll("#librarianTable tbody tr"),
          ];

          allRows.forEach((row) => {
            row.style.display = row.textContent.toLowerCase().includes(term)
              ? ""
              : "none";
          });
        }

        searchBtn.onclick = runSearch;
        searchInput.onkeyup = runSearch;

        // Modal handling
        const addUserModal = document.getElementById("addUserModal");
        const addStudentBtn = document.getElementById("addStudentBtn");
        const addLibrarianBtn = document.getElementById("addLibrarianBtn");
        const closeBtn = addUserModal.querySelector(".close");
        const addUserForm = document.getElementById("addUserForm");

        let currentRole = "student"; // default

        // Open modal for Student
        addStudentBtn.onclick = () => {
          currentRole = "student";

          // Show student fields
          ["student_id", "program_course", "year_level"].forEach((id) => {
            const el = document.getElementById(id);
            el.parentElement.style.display = "";
            el.disabled = false;
          });

          // Hide librarian fields
          document.getElementById("librarianFields").style.display = "none";
          document
            .querySelectorAll("#librarianFields input, #librarianFields select")
            .forEach((el) => (el.disabled = true));

          addUserModal.querySelector("h2").textContent = "Add Student";
          addUserModal.style.display = "block";
        };

        // Open modal for Librarian
        addLibrarianBtn.onclick = () => {
          currentRole = "librarian";

          // Hide student fields
          ["student_id", "program_course", "year_level"].forEach((id) => {
            const el = document.getElementById(id);
            el.parentElement.style.display = "none";
            el.disabled = true;
          });

          // Show librarian fields
          const librarianFields = document.getElementById("librarianFields");
          librarianFields.style.display = "";
          librarianFields
            .querySelectorAll("input, select")
            .forEach((el) => (el.disabled = false));

          addUserModal.querySelector("h2").textContent = "Add Librarian";
          addUserModal.style.display = "block";
        };

        // Close modal
        closeBtn.onclick = () => (addUserModal.style.display = "none");
        window.onclick = (event) => {
          if (event.target === addUserModal)
            addUserModal.style.display = "none";
        };

        // Handle form submission
        addUserForm.onsubmit = async (e) => {
          e.preventDefault();

          const submitButton = addUserForm.querySelector(
            "button[type='submit']"
          );
          submitButton.disabled = true;

          // Add spinner element
          const spinner = document.createElement("span");
          spinner.className = "button-spinner";
          submitButton.appendChild(spinner);

          const formData = {
            full_name: document.getElementById("full_name").value,
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
          };

          if (currentRole === "student") {
            formData.student_id = document.getElementById("student_id").value;
            formData.program_course =
              document.getElementById("program_course").value;
            formData.year_level = document.getElementById("year_level").value;
          } else if (currentRole === "librarian") {
            formData.username = document.getElementById("username").value;
            formData.role = "librarian";
          }

          const endpoint =
            currentRole === "librarian"
              ? "https://thesis-scan-backend-production.up.railway.app/librarian/"
              : "https://thesis-scan-backend-production.up.railway.app/users/";
          // "http://127.0.0.1:8000/users/";

          try {
            const response = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Failed to create user");
            }

            addUserModal.style.display = "none";
            notyf.success(
              `${
                currentRole === "librarian" ? "Librarian" : "Student"
              } added successfully!`
            );

            addUserForm.reset();
            await fetchUsers();
          } catch (error) {
            console.error("Error adding user:", error);
            notyf.error(error.message);
          } finally {
            submitButton.disabled = false;
            spinner.remove(); // remove spinner when done
          }
        };

        // Initial data load
        await fetchStats();
        await fetchUsers();
      });
    </script>
  </body>
</html>
